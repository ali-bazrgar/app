<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>AI Chat</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Toast Notification Container -->
  <div id="toast-container" class="toast-container"></div>

  <button id="translate-selection-btn" class="floating-btn hidden">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6.2c.4.2.6.7.4 1.1l-3.2 7.2c-.2.5-.6.8-1.1.8H6.8c-.5 0-.9-.3-1.1-.8L2.4 7.3c-.2-.4 0-.9.4-1.1l7.2-3.2c.5-.2.9 0 1.1.4L14 7l2-3.5-2-3.5 4.5 2.2z"></path><path d="M12 22v-6"></path></svg>
    Translate
  </button>

  <div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p>Loading AI Chat...</p>
  </div>

  <div id="chat-name-modal" class="modal hidden">
    <div class="modal-content">
  <h2>New Chat</h2>
      <p>Enter chat name:</p>
      <input type="text" id="chat-name-input" placeholder="New Chat" value="New Chat">
      <div class="modal-buttons">
        <button id="cancel-chat-name" class="btn-secondary">Cancel</button>
        <button id="save-chat-name" class="btn-primary">Create</button>
      </div>
    </div>
  </div>
    
  <div id="import-text-modal" class="modal hidden">
    <div class="modal-content">
  <h2>Import Text</h2>
        <p>Paste your text below or upload a .txt file.</p>
        <textarea id="import-textarea" placeholder="Paste text here..."></textarea>
        <div class="modal-buttons">
            <button id="import-from-file-btn" class="btn-secondary">Upload .txt File</button>
            <input type="file" id="file-input" class="hidden" accept=".txt">
            <button id="import-from-clipboard-btn" class="btn-secondary">Paste from Clipboard</button>
        </div>
        <div class="modal-buttons">
            <button id="cancel-import-btn" class="btn-secondary">Cancel</button>
            <button id="create-chat-from-import-btn" class="btn-primary">Create Chat</button>
        </div>
    </div>
  </div>

  <div id="document-name-modal" class="modal hidden">
    <div class="modal-content">
      <h2 id="document-modal-title">New Document</h2>
      <p id="document-modal-description">Enter name:</p>
      <input type="text" id="document-name-input" placeholder="Document name">
      <div class="document-parent-selector" id="document-parent-selector">
        <label for="document-parent-select">Location:</label>
        <select id="document-parent-select" class="settings-select">
          <option value="">Root (No parent)</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button id="cancel-document-name" class="btn-secondary">Cancel</button>
        <button id="save-document-name" class="btn-primary">Create</button>
      </div>
    </div>
  </div>

  <div id="settings-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Settings</h2>
      <div class="modal-scroll">
        <div class="setting-section">
          <p>AI Provider:</p>
          <select id="chat-provider-select" class="settings-select">
              <option value="gemini">Provider 1</option>
              <option value="avalai">Provider 2</option>
              <option value="openrouter">Provider 3</option>
          </select>
        </div>
        
        <div class="setting-section">
          <p>Text-to-Speech Provider:</p>
          <select id="tts-provider-select" class="settings-select">
              <option value="gemini">Provider 1</option>
              <option value="avalai">Provider 2</option>
              <option value="elevenlabs">Provider 3</option>
          </select>
        </div>

        <div class="setting-section">
            <p>API Key (Provider 1):</p>
            <input type="password" id="new-api-key-input" placeholder="Enter your API key...">
        </div>
        <div class="setting-section">
            <p>API Key (Provider 2):</p>
            <input type="password" id="avalai-api-key-input" placeholder="Enter your API key...">
        </div>

        <div class="setting-section">
          <p>API Key (OpenRouter):</p>
          <input type="password" id="openrouter-api-key-input" placeholder="Enter your OpenRouter API key...">
        </div>
        <div class="setting-section">
          <p>API Key (ElevenLabs):</p>
          <input type="password" id="elevenlabs-api-key-input" placeholder="Enter your ElevenLabs API key...">
        </div>

        <div class="setting-section">
          <p>ElevenLabs Voice ID (Brian):</p>
          <input type="text" id="elevenlabs-voice-id-input" placeholder="Enter voice_id (optional)">
          <small style="color: #666; display: block; margin-top: 5px;">Optional. If your ElevenLabs key lacks <b>voices_read</b>, paste Brian’s voice_id here so the app can call TTS without listing voices.</small>
        </div>
        
        <div class="setting-section">
            <p>Theme:</p>
            <select id="theme-select" class="settings-select">
              <option value="light">Light</option>
              <option value="dark">Dark</option>
              <option value="beige">Beige</option>
              <option value="rgb-glass">RGB Glass ✨</option>
            </select>
        </div>
        
        <div class="setting-section">
            <p>Font Size: <span id="font-size-value">14</span>px</p>
            <input type="range" id="font-size-select" class="font-size-slider" min="10" max="24" value="14" step="1">
            <div style="display: flex; justify-content: space-between; color: #999; font-size: 11px; margin-top: 4px;">
              <span>Small (10px)</span>
              <span>Large (24px)</span>
            </div>
            <small style="color: #666; display: block; margin-top: 5px;">Affects chat messages, documents, and popups</small>
        </div>
        
        <div class="setting-section">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="bold-text-checkbox" style="cursor: pointer;">
              <span>Bold Text (All Messages)</span>
            </label>
            <small style="color: #666; display: block; margin-top: 5px;">Makes all message text bold for better readability</small>
        </div>
        
        <div class="setting-section">
            <p>Dictionary:</p>
            <div class="modal-buttons">
              <button id="import-dictionary-btn" class="btn-secondary">Import Dictionary</button>
              <input type="file" id="dictionary-import-input" class="hidden" accept=".json">
              <button id="export-dictionary-btn" class="btn-secondary">Export Dictionary</button>
            </div>
        </div>
        <div class="setting-section">
            <p>Application Data:</p>
            <div class="modal-buttons">
              <button id="import-app-data-btn" class="btn-secondary">Import Data</button>
              <input type="file" id="app-data-import-input" class="hidden" accept=".json">
              <button id="export-app-data-btn" class="btn-secondary">Export Data</button>
            </div>
        </div>
      </div>
      <div class="modal-buttons modal-buttons-footer">
        <button id="cancel-settings" class="btn-secondary">Cancel</button>
        <button id="save-settings" class="btn-primary">Save Settings</button>
      </div>
    </div>
  </div>

  <div id="word-meaning-popup" class="word-meaning-popup hidden">
    <div class="popup-content">
      <div class="popup-header">
        <h3 id="word-meaning-title">Word Meaning</h3>
        <div class="popup-header-actions">
            <button id="play-word-audio-btn" class="btn-icon" title="Play Word">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
            </button>
            <button id="review-word-btn" class="btn-icon hidden" title="Review This Card">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            </button>
            <button id="add-to-leitner-btn" class="btn-icon" title="Add to Flashcards">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
            </button>
            <button id="close-word-meaning" class="popup-close">×</button>
        </div>
      </div>
      <div class="popup-body">
        <div class="word-meanings">
          <div class="meaning-section">
            <h4>Meanings</h4>
            <div id="meanings-list" class="meanings-list"></div>
          </div>
          <div class="synonyms-section">
            <h4>Synonyms</h4>
            <div id="synonyms-list" class="synonyms-list"></div>
          </div>
          <div class="antonyms-section">
            <h4>Antonyms</h4>
            <div id="antonyms-list" class="antonyms-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="translation-popup" class="translation-popup hidden">
    <div class="popup-content">
      <div class="popup-header">
  <h3>Translation</h3>
        <div class="popup-header-actions">
            <button id="play-translation-audio-btn" class="btn-icon" title="Play Translation">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
            </button>
            <button id="close-translation" class="popup-close">×</button>
        </div>
      </div>
      <div class="popup-body">
        <div class="translation-content">
          <div class="original-text">
            <strong>Original:</strong>
            <p id="original-text"></p>
          </div>
          <div class="translated-text">
            <strong>Translation:</strong>
            <p id="translated-text"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="leitner-modal" class="modal hidden">
    <div class="leitner-container">
        <div class="leitner-header">
            <h2>Flashcard Review</h2>
            <div class="leitner-stats">
                <span id="leitner-stats-new">New: 0</span>
                <span id="leitner-stats-due">Due: 0</span>
            </div>
            <button id="close-leitner-btn" class="popup-close">×</button>
        </div>
        <div class="leitner-body">
            <div id="leitner-card-container">
                <div class="leitner-card">
                    <div class="card-front">
                        <p id="card-front-text">Word</p>
                        <button id="leitner-play-audio-btn" class="btn-icon btn-audio-card-front" title="Play Word">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                        </button>
                    </div>
                    <div class="card-back">
                        <div id="card-back-text"></div>
                    </div>
                </div>
            </div>
            <div id="leitner-initial-controls">
                <button id="show-answer-btn" class="btn-primary">Show Answer <small style="opacity: 0.7; font-size: 11px;">(Space/Enter)</small></button>
            </div>
            <div id="leitner-rating-controls" class="hidden">
                <button class="btn-leitner-rating" id="rating-again">Again <small>1</small></button>
                <button class="btn-leitner-rating" id="rating-hard">Hard <small>2</small></button>
                <button class="btn-leitner-rating" id="rating-good">Good <small>3</small></button>
                <button class="btn-leitner-rating" id="rating-easy">Easy <small>4</small></button>
            </div>
        </div>
        <div id="leitner-finished-screen" class="hidden">
            <h3>Congratulations!</h3>
            <p>You have finished your review for today.</p>
            <button id="leitner-finished-ok" class="btn-primary">OK</button>
        </div>
    </div>
  </div>

  <div id="app" class="hidden">
    <div class="sidebar">
      <div class="sidebar-switcher">
        <button class="sidebar-tab active" data-section="chat">Chats</button>
        <button class="sidebar-tab" data-section="documents">Documents</button>
      </div>

      <div id="chat-sidebar-section" class="sidebar-section">
        <div class="sidebar-header">
          <h1>Chats</h1>
          <div class="sidebar-header-actions">
              <button id="import-chat-btn" class="btn-icon" title="Import Text">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              </button>
              <button id="sidebar-new-chat-btn" class="btn-icon" title="New Chat">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>
          </div>
        </div>
        <div class="chat-list-container">
          <ul id="chat-list-items"></ul>
        </div>
      </div>

      <div id="document-sidebar-section" class="sidebar-section hidden">
        <div class="sidebar-header">
          <h1>Documents</h1>
          <div class="sidebar-header-actions">
              <button id="document-import-btn" class="btn-icon" title="Import Document">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              </button>
              <input type="file" id="document-import-input" class="hidden" accept=".txt,.md,.json,.html">
              <button id="document-new-file-btn" class="btn-icon" title="New Document">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="12" x2="12" y2="18"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
              </button>
              <button id="document-new-folder-btn" class="btn-icon" title="New Folder">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h5l2 3h9a1 1 0 0 1 1 1v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"></path></svg>
              </button>
          </div>
        </div>
        <div class="document-tree-container">
          <ul id="document-tree" class="document-tree"></ul>
        </div>
      </div>

      <div class="sidebar-footer">
        <div class="copyright">© Ali Bazrgar</div>
        <button id="settings-btn" class="btn-secondary">Settings</button>
      </div>
    </div>

    <div class="main-content">
      <div id="chat-main" class="main-panel">
        <div class="chat-header">
          <div class="header-left">
            <button id="menu-toggle" class="btn-icon mobile-only">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <h2 id="chat-title">New Chat</h2>
          </div>
          <div class="chat-actions">
            <button id="global-leitner-btn" class="btn-icon" title="Global Flashcard Review">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
              </svg>
            </button>
            <button id="current-chat-leitner-btn" class="btn-icon" title="Review This Chat's Words">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M7 15h5"></path>
                <path d="M7 11h10"></path>
              </svg>
            </button>
            <button id="header-new-chat-btn" class="btn-icon" title="New Chat">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
            <button id="rename-chat" class="btn-icon" title="Rename">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button id="delete-chat" class="btn-icon danger" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="messages-container">
          <div id="messages" class="messages"></div>
        </div>

        <div class="input-area">
          <div class="input-container">
            <button id="voice-btn" class="btn-voice" title="Voice Input">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
            </button>
            <textarea id="message-input" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-btn" class="btn-send">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
            </button>
          </div>
        </div>
      </div>

      <div id="documents-main" class="main-panel hidden">
        <div class="document-header">
          <div class="header-left">
            <button id="document-menu-toggle" class="btn-icon mobile-only">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
              </svg>
            </button>
            <h2 id="document-title">Documents</h2>
          </div>
          <div class="document-actions">
            <button id="document-leitner-btn" class="btn-icon" title="Review This Folder or Document">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M7 11h10"></path>
                <path d="M7 15h6"></path>
              </svg>
            </button>
            <button id="document-rename-btn" class="btn-icon" title="Rename">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button id="document-delete-btn" class="btn-icon danger" title="Delete">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
        <div class="document-editor-container">
          <div id="document-empty-state" class="document-empty-state">
            Select or create a document to begin.
          </div>
          <div id="document-content-view" class="document-content-view hidden"></div>
          <textarea id="document-editor" class="document-editor hidden" placeholder="Start writing..."></textarea>
        </div>
        <div class="document-footer">
          <button id="document-edit-btn" class="btn-secondary">Edit</button>
          <button id="document-save-btn" class="btn-primary hidden">Save Changes</button>
          <button id="document-cancel-btn" class="btn-secondary hidden">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>
